name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to Cloudflare Pages (Production)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: cloudflare/wrangler-action@v3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ vars.CLOUDFLARE_PAGES_PROJECT || secrets.CLOUDFLARE_PAGES_PROJECT }} --branch=master --commit-dirty=true

      - name: Cleanup old production deployments
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ vars.CLOUDFLARE_PAGES_PROJECT || secrets.CLOUDFLARE_PAGES_PROJECT }}
        run: |
          echo "Fetching production deployments..."

          # Get all production deployments sorted by creation date (newest first)
          DEPLOYMENTS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            | jq -r '.result[] | select(.environment == "production") | .id' \
            | tail -n +2)

          if [ -z "$DEPLOYMENTS" ]; then
            echo "No old production deployments to clean up"
            exit 0
          fi

          echo "Found old production deployments to delete:"
          echo "$DEPLOYMENTS"

          # Delete each old deployment (keeping the first/newest one)
          for DEPLOYMENT_ID in $DEPLOYMENTS; do
            echo "Deleting deployment ${DEPLOYMENT_ID}..."
            RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments/${DEPLOYMENT_ID}?force=true" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}")

            SUCCESS=$(echo $RESPONSE | jq -r '.success')
            if [ "$SUCCESS" = "true" ]; then
              echo "Successfully deleted deployment ${DEPLOYMENT_ID}"
            else
              echo "Failed to delete deployment ${DEPLOYMENT_ID}"
              echo "Response: $RESPONSE"
            fi
          done

          echo "Production cleanup complete"

      - name: Deploy to Cloudflare Pages (Preview)
        id: deploy-preview
        if: github.event_name == 'pull_request'
        uses: cloudflare/wrangler-action@v3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ vars.CLOUDFLARE_PAGES_PROJECT || secrets.CLOUDFLARE_PAGES_PROJECT }} --branch=pr-${{ github.event.number }} --commit-dirty=true

      - name: Update PR description with preview URL
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PROJECT_NAME: ${{ vars.CLOUDFLARE_PAGES_PROJECT || secrets.CLOUDFLARE_PAGES_PROJECT }}
        run: |
          PREVIEW_URL="https://pr-${PR_NUMBER}.${PROJECT_NAME}.pages.dev"

          # Get current PR body
          CURRENT_BODY=$(gh pr view ${PR_NUMBER} --json body --jq '.body')

          # Create preview section
          PREVIEW_SECTION="---

          **Preview Deployment:** ${PREVIEW_URL}"

          # Check if preview section already exists
          if echo "$CURRENT_BODY" | grep -q "Preview Deployment:"; then
            # Update existing preview URL
            NEW_BODY=$(echo "$CURRENT_BODY" | sed "s|Preview Deployment:.*|Preview Deployment:** ${PREVIEW_URL}|")
          else
            # Append preview section
            NEW_BODY="${CURRENT_BODY}${PREVIEW_SECTION}"
          fi

          # Update PR description
          gh pr edit ${PR_NUMBER} --body "$NEW_BODY"
