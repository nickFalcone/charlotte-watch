# Warm the news parsed cache so users get fast responses (cache hit).
# Runs every 8 hours: morning, afternoon, and evening Eastern (Charlotte).
name: Warm news cache

on:
  schedule:
    # 04:00 UTC = 11:00 PM Eastern (prev day EST) / 12:00 AM Eastern (EDT)
    - cron: '0 4 * * *'
    # 12:00 UTC = 7:00 AM Eastern (EST) / 8:00 AM Eastern (EDT)
    - cron: '0 12 * * *'
    # 20:00 UTC = 3:00 PM Eastern (EST) / 4:00 PM Eastern (EDT)
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  warm:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Warm news cache
        env:
          CACHE_WARMING_SECRET: ${{ secrets.CACHE_WARMING_SECRET }}
        run: |
          echo "Calling production news endpoint to populate KV cache..."
          HTTP_CODE=$(curl -sS -o /tmp/response.json -w "%{http_code}" --max-time 180 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36" \
            -H "Accept: application/json, text/plain, */*" \
            -H "Accept-Language: en-US,en;q=0.9" \
            -H "Referer: https://clt.watch/" \
            -H "X-Cache-Warming-Secret: ${CACHE_WARMING_SECRET}" \
            "https://clt.watch/api/news-charlotte-parsed")
          echo "Response HTTP $HTTP_CODE"

          # Extract cache status if available
          CACHE_STATUS=$(grep -i "X-Cache-Status" /tmp/response_headers.txt 2>/dev/null | cut -d: -f2 | tr -d ' \r' || echo "")

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            if [ -n "$CACHE_STATUS" ]; then
              echo "Cache warm succeeded. Status: $CACHE_STATUS"
            else
              echo "Cache warm succeeded."
            fi
          else
            echo "Unexpected response. Body head:"
            head -c 200 /tmp/response.json
            exit 1
          fi
